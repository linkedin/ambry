## Terminologies

HardwareLayout   - Has information about the nodes available in the cluster. disks for those nodes and their states
PartitionLayout  - Has information about the partitions and its replicas
Blobid           - BlobId of the blob/object which was generated by ambry on put


## Set up
To execute this tool, ./gradlew allJar in the root directory.
This will generate ambry.jar in "target" folder under root directory.
This jar will assist using these tools.


## DumpData
This tool is used to dump the data parsing the storage files.

#### Operations supported
* Dumping log file
* Dumping index file
* Dumping replicaToken
* Compare index entries to log contents

## BlobValidator
This tool is used to perform read operations for a blob directly from the server.

#### Operations supported:
* Get blob(deserialize blob) for a given blob id for all its replicas
* Get blob(deserialize blob) for a given blob id for local replicas in a datacenter
* Get blob(deserialize blob) for a given blob id for the given replica

## AdminTool
This tool exposes some admin APIs to get more information for debugging purposes

#### Operations supported
* List replicas for a blobid

## Examples

### Dumping Index

#### Dump Index
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile]
 --partitionLayout [PartitionLayoutFile] --typeOfOperation DumpIndex --fileToRead [indexFile]
```

#### Dump index filtering for a list of blobs
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile] --partitionLayout
[PartitionLayoutFile] --typeOfOperation DumpIndex --fileToRead [indexFile] --listOfBlobs [blobid1,blobid2,blobid3]
```

#### Dump all indexes in a replica
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile] --partitionLayout
[PartitionLayoutFile] --typeOfOperation DumpIndexesForReplica --replicaRootDirectory [replicaRootDirecotry]
--avoidTraceLogging true
```

#### Dump Active blobs in an index
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile] --partitionLayout
[PartitionLayoutFile] --typeOfOperation DumpIndex --fileToRead [indexFile] --activeBlobsOnly true
```

#### Dump all active blobs in a replica
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile] --partitionLayout
[PartitionLayoutFile] --typeOfOperation DumpIndexesForReplica --replicaRootDirectory [replicaRootDirecotry]
--activeBlobsOnly true --avoidTraceLogging true
```

#### Dump N Random active blobs for a given replica
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile] --partitionLayout
[PartitionLayoutFile] --typeOfOperation DumpNRandomActiveBlobsForReplica --replicaRootDirectory [replicaRootDirecotry]
--activeBlobsCount 10000 --avoidTraceLogging true
```

### Dumping Log

#### Dump log file
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --typeOfOperation DumpLog --fileToRead [logFile]
```

#### Dump log file with throttling
```bash
java -cp ambry.jar com.github.ambry.store.DumpData --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --typeOfOperation DumpLog --fileToRead [logFile] --bytesPerSec 1000
```

#### Dump log starting at offset x and ending at offset y
```bash
java -cp ambry.jar com.github.ambry.store.DumpData
--hardwareLayout [HardwareLayoutFile] --partitionLayout [PartitionLayoutFile] --typeOfOperation DumpLog
--fileToRead [logFile] --startOffset x --endOffset y
```

#### Dump log filtering with a set of blobs
```bash
java -cp ambry.jar com.github.ambry.store.DumpData
--hardwareLayout [HardwareLayoutFile] --partitionLayout [PartitionLayoutFile] --typeOfOperation DumpLog
--fileToRead [logFile] --listOfBlobs [blobid1,blobid2,blobid3]
```

### Comparing index entries to log entries(or in other words, trying to read a log record based on index info for
### every entry in the index)
```bash
java -cp ambry.jar com.github.ambry.store.DumpData
--hardwareLayout [HardwareLayoutFile] --partitionLayout [PartitionLayoutFile] --typeOfOperation CompareIndexToLog
--fileToRead [indexFile] --logFileToDump [logFile]
```

### Comparing all index entries for a replica to log entries
```bash
java -cp ambry.jar com.github.ambry.store.DumpData
--hardwareLayout [HardwareLayoutFile] --partitionLayout [PartitionLayoutFile] --typeOfOperation
CompareReplicaIndexesToLog --replicaRootDirectory [replicaRootDirectory] --logFileToDump [logFile]
```

### Compare Log Entries to Indexes
```bash
java -cp ambry.jar com.github.ambry.store.DumpData
--hardwareLayout [HardwareLayoutFile] --partitionLayout [PartitionLayoutFile] --typeOfOperation
CompareLogToIndex --replicaRootDirectory [replicaRootDirectory] --logFileToDump [logFile]
```

### BlobValidator

#### Get blob from all replicas
```bash
java -cp ambry.jar com.github.ambry.tools.admin.BlobValidator --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --typeOfOperation VALIDATE_BLOB_ON_ALL_REPLICAS --ambryBlobId [blobid]
```

#### Get blob from all replicas from a datacenter
```bash
java -cp ambry.jar com.github.ambry.tools.admin.BlobValidator --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --typeOfOperation VALIDATE_BLOB_ON_DATACENTER --fabric [fabric]
--ambryBlobId [blobid]
```

#### Get blob from a replica
```bash
java -cp ambry.jar com.github.ambry.tools.admin.BlobValidator --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --typeOfOperation VALIDATE_BLOB_ON_REPLICA --ambryBlobId [blobid]
--replicaHost [replicaHost] --replicaPort [replicaPort]
```

### AdminTool

#### List Replicas
```bash
java -cp ambry.jar com.github.ambry.tools.admin.AdminTool --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --typeOfOperation LIST_REPLICAS --ambryBlobId [blobid]
```

### ConsistencyCheckerTool

#### Check for consistency among replicas for a partition
```bash
java -cp ambry.jar com.github.ambry.store.ConsistencyCheckerTool --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --rootDirectoryForPartition [rootDirectory which contains replicas which in
turn contains all index files] --outFile [outFile]
```

#### Check for consistency of index file boundaries on all replicas of a partition
```bash
java -cp ambry.jar com.github.ambry.store.ConsistencyCheckerTool --hardwareLayout [HardwareLayoutFile]
--partitionLayout [PartitionLayoutFile] --rootDirectoryForPartition [rootDirectory which contains replicas which in
turn contains all index files] --subject index --outFile [outFile]
```

```
Root Directory for Partition should contains N sub-directories pertaining to N replicas. Each sub-directory's name
should be the same as name of the replica. Each sub directory(replica) in turn should have all the index segments within it.

A sample structure of a root Directory:

rootDir
  ela4-app8763.prod.linkedin.com
    0_index
    10264262199_index
    10821344563_index
  lva1-app6774.prod.linkedin.com
    0_index
    10267816698_index
    10892574781_index
  lva1-app6775.prod.linkedin.com
    0_index
    10266323380_index
    10888037904_index
```


###ConcurrencyTestTool
####Sample test run

Ensure that ambry servers in the HardwareLayout are up running

```bash
java -cp ambry.jar com.github.ambry.tools.admin.ConcurrencyTestTool --hardwareLayout [HardwareLayoutFile]
 --partitionLayout [PartitionLayoutFile] --putGetHelperFactory com.github.ambry.tools.admin.RouterPutGetHelperFactory
 --maxParallelPutCount 2 --parallelGetCount 4 --burstCountForGet 4 --maxGetCountPerBlob 10
 --totalPutBlobCount 1000 --maxBlobSizeInBytes 1000 --minBlobSizeInBytes 100 --routerPropsFilePath [Path to router props
 file] --deleteAndValidate true
```
