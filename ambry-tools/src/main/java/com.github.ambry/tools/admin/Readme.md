## Terminologies

HardwareLayout   - Has information about the nodes available in the cluster. disks for those nodes and their states
PartitionLayout  - Has information about the partitions and its replicas
Blobid           - BlobId of the blob/object which was generated by ambry on put


## Set up
To execute this tool, ./gradlew allJar in the root directory.
This will generate ambry.jar in "target" folder under root directory.
This jar will assist using these tools.


## DumpLogTool, DumpIndexTool, DumpReplicaTokenTool and DumpDataTool
These tools are used to dump the data parsing the storage files.

#### Operations supported
* Dumping log file
* Dumping index file
* Dumping replicaToken
* Compare index entries to log contents

## BlobValidator
This tool can be used validate blobs in a single replica, in all replicas in a datacenter or across all replicas.

#### Operations supported:
* Get blob from all replicas and compare the record across replicas for a list of blob ids.
* Get blob from all replicas in a datacenter and compare the record across replicas for a list of blob ids.
* Get blob from a specific replica and ensure that it deserializes correctly for a list of blob ids.

## ServerAdminTool
This tool can be used to operate on a single ambry server. Please refer to the config documentation and the class 
documentation for usage details.

#### Operations supported
* GetBlobProperties
* GetBlobUserMetadata
* GetBlob
* TriggerCompaction

## Examples

### Dumping Index

#### Dump Index
```bash
java -cp ambry.jar com.github.ambry.store.DumpIndexTool --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=DumpIndex
file.to.read=[indexFile]
silent=false
```

#### Dump index filtering for a list of blobs
```bash
java -cp ambry.jar com.github.ambry.store.DumpIndexTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=DumpIndex
file.to.read=[indexFile]
blobId.list=blobid1,blobid2,blobid3
silent=false
```

#### Dump all indexes in a replica
```bash
java -cp ambry.jar com.github.ambry.store.DumpIndexTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=DumpIndexesForReplica
replica.root.directory=[replicaRootDirecotry]
```

#### Dump Active blobs in an index
```bash
java -cp ambry.jar com.github.ambry.store.DumpIndexTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=DumpIndex
file.to.read=[indexFile]
active.blobs.only=true
silent=false
```

#### Dump all active blobs in a replica
```bash
java -cp ambry.jar com.github.ambry.store.DumpIndexTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=DumpIndexesForReplica
replica.root.directory=[replicaRootDirecotry]
active.blobs.only=true
silent=false
```

#### Dump N Random active blobs for a given replica
```bash
java -cp ambry.jar com.github.ambry.store.DumpIndexTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=DumpNRandomActiveBlobsForReplica
replica.root.directory=[replicaRootDirecotry]
active.blobs.count=1000
silent=false
```

### Dumping Log

#### Dump log file
```bash
java -cp ambry.jar com.github.ambry.store.DumpLogTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
file.to.read=[LogFile]
silent=false
```

#### Dump log file with throttling
```bash
java -cp ambry.jar com.github.ambry.store.DumpLogTool --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
file.to.read=[LogFile]
blobs.per.sec=100
silent=false
```

#### Dump log starting at offset x and ending at offset y
```bash
java -cp ambry.jar com.github.ambry.store.DumpLogTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
file.to.read=[LogFile]
log.start.offset=x
log.end.offset=y
silent=false
```

#### Dump log filtering with a set of blobs
```bash
java -cp ambry.jar com.github.ambry.store.DumpLogTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
file.to.read=[LogFile]
blobId.list=blobId1,blobId2,blobId3
silent=false
```

### Comparison operations

#### Comparing index entries to log entries(or in other words, trying to read a log record based on index info for
#### every entry in the index)
```bash
java -cp ambry.jar com.github.ambry.store.DumpDataTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=CompareIndexToLog
file.to.read=[indexFile]
```

#### Comparing all index entries for a replica to log entries
```bash
java -cp ambry.jar com.github.ambry.store.DumpDataTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
type.of.operation=CompareReplicaIndexesToLog
replica.root.directory=[replicaRootDirecotry]
index.files.per.sec=1 // number of index files to process per sec
```

### Dumping ReplicaToken file
```bash
java -cp ambry.jar com.github.ambry.store.DumpReplicaTokenTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
file.to.read=[replicaTokenFile]
```

### BlobValidator
This tool can be used validate blobs in a single replica, in all replicas in a datacenter or across all replicas. Please
refer to the config documentation and the class  documentation for usage details.

```bash
java -cp ambry.jar com.github.ambry.tools.admin.ServerAdminTool --propsFile [props file path]
```

### ServerAdminTool
```bash
java -cp ambry.jar com.github.ambry.tools.admin.ServerAdminTool --propsFile [props file path]
```

### ConsistencyCheckerTool

#### Check for consistency among replicas for a partition
```bash
java -cp ambry.jar com.github.ambry.store.ConsistencyCheckerTool  --propsFile [Config file path]
//Contents of config file
hardware.layout.file.path=[HardwareLayoutFile]
partition.layout.file.path=[PartitionLayoutFile]
partition.root.directory=[Root directory which contains one directory per replica. Each replica's directory is expected 
to contain all index files for the respective replica. Diretory's name is considered to be replica name for logging 
purposes]
```


```
Root Directory for Partition should contains N sub-directories pertaining to N replicas. Each sub-directory's name
should be the same as name of the replica. Each sub directory(replica) in turn should have all the index segments within it.

A sample structure of a root Directory:

rootDir
  ela4-app8763.prod.linkedin.com
    0_index
    10264262199_index
    10821344563_index
  lva1-app6774.prod.linkedin.com
    0_index
    10267816698_index
    10892574781_index
  lva1-app6775.prod.linkedin.com
    0_index
    10266323380_index
    10888037904_index
```


###ConcurrencyTestTool
####Sample test run

Ensure that ambry servers in the HardwareLayout are up running

```bash
java -cp ambry.jar com.github.ambry.tools.admin.ConcurrencyTestTool --hardwareLayout [HardwareLayoutFile]
 --partitionLayout [PartitionLayoutFile] --putGetHelperFactory com.github.ambry.tools.admin.RouterPutGetHelperFactory
 --maxParallelPutCount 2 --parallelGetCount 4 --burstCountForGet 4 --maxGetCountPerBlob 10
 --totalPutBlobCount 1000 --maxBlobSizeInBytes 1000 --minBlobSizeInBytes 100 --routerPropsFilePath [Path to router props
 file] --deleteAndValidate true
```
